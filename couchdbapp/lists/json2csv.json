{
    "_id": "_design/couchdbapp",
    "lists": {
        "json2csv": "function(head, req) {\n    //adapted from: https://developer.ibm.com/clouddataservices/2015/09/22/export-cloudant-json-as-csv-rss-or-ical/\n    var row, first = true;\n\n    // output HTTP headers\n    start({\n        headers: {  'Content-Type': 'text/csv'  },\n    });\n\n    // iterate through the result set\n    while(row = getRow()) {\n\n        // get the doc (include_docs=true)\t\t\n        //var doc = row.doc;\n        var doc = row.value;\n\n        // if this is the first row\n        if (first) {\n\n            // output column headers\n            send(Object.keys(doc).join(',') + '\\n'); // for use in R newline '\\n'\n            first = false;\n        }\n\n        // build up a line of output\n        var line = '';\n\n        // iterate through each row\n        for(var i in doc) {\n\n            // comma separator\n            if (line.length > 0) {\n                line += ',';\n            }\n\n            // output the value, ensuring values that themselves\n            // contain commas are enclosed in double quotes\n            var val = doc[i];\n            if (typeof val == 'string' && val.indexOf(',') >  -1) {\n                line += '\"' + val.replace(/\"/g,'\"\"') + '\"';\n            } else {\n                line += val;\n            }\n        }\n        line += '\\n'; // for use in R newline '\\n'\n\n        // send  the line\n        send(line);\n    }\n}"
    }
}
